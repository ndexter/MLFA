#!/bin/bash

tfa
python --version

echo "CONTROL: starting runs on test datasets"

declare -r input_dim=1
declare -r run_ID="test_github"
declare -r training_ptset="uniform_random"
declare -r example="logsin_plus_sin_K1"
declare -r blocktype="default"
declare -r activation="relu"
declare -r precision="single"
declare -r optimizer="SGD"
declare -r use_regularizer=0
declare -r reg_lambda="1e-3"
declare -r make_plots=0
declare -r initializer="normal"
declare -r sigma="1e-1"
declare -r lrn_rate_schedule="exp_decay"

if [ "$precision" = "single" ]; then
    declare -r nb_epochs="50000"
    declare -r error_tol="5e-7"
elif [ "$precision" = "double" ]; then
    declare -r nb_epochs="200000"
    declare -r error_tol="5e-16"
fi

echo $nb_epochs

declare -A train_pts
if [ "$training_ptset" = "uniform_random" ]; then
    if [ "$input_dim" -eq "1" ]; then
        declare -r quick_test_pts=32769 #8193 
        declare -r test_pts=65537 #131073
        #train_pts[0]="75"
        #train_pts[1]="150"
        #train_pts[2]="225"
        #train_pts[3]="300"
        #train_pts[4]="375"
        #train_pts[5]="450"
        #train_pts[6]="525"
        #train_pts[7]="600"
        #train_pts[8]="675"
        #train_pts[9]="750"
        #train_pts[10]="825"
        #train_pts[11]="900"
        #train_pts[12]="975"
        #train_pts[13]="1050"
        #train_pts[14]="1125"
        #train_pts[15]="1200"
        #train_pts[16]="1275"
        #train_pts[17]="1350"
        #train_pts[18]="1425"
        #train_pts[19]="1500"
        #train_pts[20]="1575"
        #train_pts[21]="1650"
        #train_pts[22]="1725"
        #train_pts[23]="1800"
        #train_pts[24]="1875"
        #train_pts[25]="1950"
        #train_pts[26]="2025"
        #train_pts[27]="2100"
        #train_pts[28]="2175"
        #train_pts[29]="2250"
        train_pts[0]="25"
        train_pts[1]="50"
        train_pts[2]="75"
        train_pts[3]="100"
        train_pts[4]="125"
        train_pts[5]="150"
        train_pts[6]="175"
        train_pts[7]="200"
        train_pts[8]="225"
        train_pts[9]="250"
        train_pts[10]="275"
        train_pts[11]="300"
        train_pts[12]="325"
        train_pts[13]="350"
        train_pts[14]="375"
        train_pts[15]="400"
        train_pts[16]="425"
        train_pts[17]="450"
        train_pts[18]="475"
        train_pts[19]="500"
        train_pts[20]="525"
        train_pts[21]="550"
        train_pts[22]="575"
        train_pts[23]="600"
        train_pts[24]="625"
        train_pts[25]="650"
        train_pts[26]="675"
        train_pts[27]="700"
        train_pts[28]="725"
        train_pts[29]="750"
        #train_pts[0]="75"
        #train_pts[1]="150"
        #train_pts[2]="226"
        #train_pts[3]="300"
        #train_pts[4]="375"
        #train_pts[5]="450"
        #train_pts[6]="525"
        #train_pts[7]="600"
        #train_pts[8]="675"
        #train_pts[9]="750"
        #train_pts[10]="826"
        #train_pts[11]="901"
        #train_pts[12]="976"
        #train_pts[13]="1050"
        #train_pts[14]="1126"
        #train_pts[15]="1200"
        #train_pts[16]="1276"
        #train_pts[17]="1351"
        #train_pts[18]="1425"
        #train_pts[19]="1500"
    elif [ "$input_dim" -eq "2" ]; then
        declare -r quick_test_pts=32769
        declare -r test_pts=311297 #655361
        train_pts[0]="75"
        train_pts[1]="150"
        train_pts[2]="225"
        train_pts[3]="300"
        train_pts[4]="375"
        train_pts[5]="450"
        train_pts[6]="525"
        train_pts[7]="600"
        train_pts[8]="675"
        train_pts[9]="750"
        train_pts[10]="825"
        train_pts[11]="900"
        train_pts[12]="975"
        train_pts[13]="1050"
        train_pts[14]="1125"
        train_pts[15]="1200"
        train_pts[16]="1275"
        train_pts[17]="1350"
        train_pts[18]="1425"
        train_pts[19]="1500"
        train_pts[20]="1575"
        train_pts[21]="1650"
        train_pts[22]="1725"
        train_pts[23]="1800"
        train_pts[24]="1875"
        train_pts[25]="1950"
        train_pts[26]="2025"
        train_pts[27]="2100"
        train_pts[28]="2175"
        train_pts[29]="2250"
    elif [ "$input_dim" -eq "3" ]; then
        declare -r quick_test_pts=72705
        declare -r test_pts=366593
        train_pts[0]="75"
        train_pts[1]="150"
        train_pts[2]="225"
        train_pts[3]="300"
        train_pts[4]="375"
        train_pts[5]="450"
        train_pts[6]="525"
        train_pts[7]="600"
        train_pts[8]="675"
        train_pts[9]="750"
        train_pts[10]="825"
        train_pts[11]="900"
        train_pts[12]="975"
        train_pts[13]="1050"
        train_pts[14]="1125"
        train_pts[15]="1200"
        train_pts[16]="1275"
        train_pts[17]="1350"
        train_pts[18]="1425"
        train_pts[19]="1500"
        train_pts[20]="1575"
        train_pts[21]="1650"
        train_pts[22]="1725"
        train_pts[23]="1800"
        train_pts[24]="1875"
        train_pts[25]="1950"
        train_pts[26]="2025"
        train_pts[27]="2100"
        train_pts[28]="2175"
        train_pts[29]="2250"
    elif [ "$input_dim" -eq "4" ]; then
        declare -r quick_test_pts=46721
        declare -r test_pts=643073
        train_pts[0]="2025"
        train_pts[1]="2100"
        train_pts[2]="2175"
        train_pts[3]="2250"
        train_pts[4]="2325"
        train_pts[5]="2400"
        train_pts[6]="2475"
        train_pts[7]="2550"
        train_pts[8]="2625"
        train_pts[9]="2700"
        train_pts[10]="2775"
        train_pts[11]="2850"
        train_pts[12]="2925"
        train_pts[13]="3000"
        train_pts[14]="3075"
        train_pts[15]="3150"
        train_pts[16]="3225"
        train_pts[17]="3300"
        train_pts[18]="3375"
        train_pts[19]="3450"
        train_pts[20]="3525"
        train_pts[21]="3600"
        train_pts[22]="3675"
        train_pts[23]="3750"
        train_pts[24]="3825"
        train_pts[25]="3900"
        train_pts[26]="3975"
        train_pts[27]="4050"
        train_pts[28]="4125"
        train_pts[29]="4200"
        train_pts[30]="4275"
        train_pts[31]="4350"
        train_pts[32]="4425"
        train_pts[33]="4500"
        train_pts[34]="4575"
        train_pts[35]="4650"
        train_pts[36]="4725"
        train_pts[37]="4800"
        train_pts[38]="4875"
        train_pts[39]="4950"
        train_pts[40]="5025"
        #train_pts[0]="5"
        #train_pts[1]="10"
        #train_pts[2]="15"
        #train_pts[3]="20"
        #train_pts[4]="25"
        #train_pts[5]="30"
        #train_pts[6]="35"
        #train_pts[7]="40"
        #train_pts[8]="45"
        #train_pts[9]="50"
        #train_pts[10]="55"
        #train_pts[11]="60"
        #train_pts[12]="65"
        #train_pts[13]="70"
        #train_pts[14]="75"

        #train_pts[0]="75"
        #train_pts[1]="150"
        #train_pts[2]="225"
        #train_pts[3]="300"
        #train_pts[4]="375"
        #train_pts[5]="450"
        #train_pts[6]="525"
        #train_pts[7]="600"
        #train_pts[8]="675"
        #train_pts[9]="750"
        #train_pts[10]="825"
        #train_pts[11]="900"
        #train_pts[12]="975"
        #train_pts[13]="1050"
        #train_pts[14]="1125"
        #train_pts[15]="1200"
        #train_pts[16]="1275"
        #train_pts[17]="1350"
        #train_pts[18]="1425"
        #train_pts[19]="1500"
        #train_pts[20]="1575"
        #train_pts[21]="1650"
        #train_pts[22]="1725"
        #train_pts[23]="1800"
        #train_pts[24]="1875"
        #train_pts[25]="1950"
        #train_pts[26]="2025"
        #train_pts[27]="2100"
        #train_pts[28]="2175"
        #train_pts[29]="2250"
    elif [ "$input_dim" -eq "8" ]; then
        declare -r quick_test_pts=609025 #56737
        declare -r test_pts=1863937 #609025
        train_pts[0]="76"
        train_pts[1]="93"
        train_pts[2]="116"
        train_pts[3]="139"
        train_pts[4]="152"
        train_pts[5]="162"
        train_pts[6]="185"
        train_pts[7]="208"
        train_pts[8]="227"
        train_pts[9]="231"
        train_pts[10]="254"
        train_pts[11]="277"
        train_pts[12]="300"
        train_pts[13]="303"
        train_pts[14]="323"
        train_pts[15]="346"
        train_pts[16]="369"
        train_pts[17]="378"
        train_pts[18]="392"
        train_pts[19]="415"
        train_pts[20]="438"
        train_pts[21]="454"
        train_pts[22]="461"
        train_pts[23]="530"
        train_pts[24]="605"
        train_pts[25]="681"
        train_pts[26]="756"
        train_pts[27]="832"
        train_pts[28]="907"
        train_pts[29]="983"
        train_pts[30]="1059"
        train_pts[31]="1134"
        train_pts[32]="1210"
        train_pts[33]="1285"
        train_pts[34]="1361"
        train_pts[35]="1436"
        train_pts[36]="1512"
        train_pts[37]="1588"
        train_pts[38]="1663"
        train_pts[39]="1739"
        train_pts[40]="1814"
        train_pts[41]="1890"
        train_pts[42]="1965"
        train_pts[43]="2041"
        train_pts[44]="2117"

        #train_pts[0]="5"
        #train_pts[1]="10"
        #train_pts[2]="15"
        #train_pts[3]="20"
        #train_pts[4]="25"
        #train_pts[5]="30"
        #train_pts[6]="35"
        #train_pts[7]="40"
        #train_pts[8]="45"
        #train_pts[9]="50"
        #train_pts[10]="55"
        #train_pts[11]="60"
        #train_pts[12]="65"
        #train_pts[13]="70"
        #train_pts[14]="75"
        #train_pts[15]="150"
        #train_pts[16]="225"
        #train_pts[17]="300"
        #train_pts[18]="375"
        #train_pts[19]="450"
        #train_pts[20]="525"
        #train_pts[21]="600"
        #train_pts[22]="675"
        #train_pts[23]="750"
        #train_pts[24]="825"
        #train_pts[25]="900"
        #train_pts[26]="975"
        #train_pts[27]="1050"
        #train_pts[28]="1125"
        #train_pts[29]="1200"
        #train_pts[30]="1275"
        #train_pts[31]="1350"
        #train_pts[32]="1425"
        #train_pts[33]="1500"
        #train_pts[34]="1575"
        #train_pts[35]="1650"
        #train_pts[36]="1725"
        #train_pts[37]="1800"
        #train_pts[38]="1875"
        #train_pts[39]="1950"
        #train_pts[40]="2025"
        #train_pts[41]="2100"
        #train_pts[42]="2175"
        #train_pts[43]="2250"
    elif [ "$input_dim" -eq "16" ]; then
        declare -r quick_test_pts=51137
        declare -r test_pts=2098753
        train_pts[0]="1"
        train_pts[1]="33"
        train_pts[2]="545"
        train_pts[3]="6049"
        train_pts[4]="51137"
        train_pts[5]="353729"
        train_pts[6]="2098753"
    elif [ "$input_dim" -eq "100" ]; then
        declare -r test_pts=20201
        train_pts[0]="263"
        train_pts[1]="329"
        train_pts[2]="394"
        train_pts[3]="460"
        train_pts[4]="526"
        train_pts[5]="591"
        train_pts[6]="657"
        train_pts[7]="723"
        train_pts[8]="788"
        train_pts[9]="854"
        train_pts[10]="919"
        train_pts[11]="985"
        train_pts[12]="1051"
        train_pts[13]="1116"
        train_pts[14]="1182"
        train_pts[15]="1248"
        train_pts[16]="1313"
    else
        echo "input dim is 2, 4, 8, 16, or 100"
    fi
elif [ "$training_ptset" = "CC_sparse_grid" ]; then
    if [ "$input_dim" -eq "2" ]; then
        declare -r quick_test_pts=655361
        declare -r test_pts=655361
        train_pts[0]="1"
        train_pts[1]="5"
        train_pts[2]="13"
        train_pts[3]="29"
        train_pts[4]="65"
        train_pts[5]="145"
        train_pts[6]="321"
        train_pts[7]="705"
        train_pts[8]="1537"
        train_pts[9]="3329"
        train_pts[10]="7169"
        train_pts[11]="15361"
        train_pts[12]="32769"
        train_pts[13]="69633"
        train_pts[14]="147457"
        train_pts[15]="311297"
        train_pts[16]="655361"
        train_pts[17]="1376257"
    elif [ "$input_dim" -eq "16" ]; then
        declare -r quick_test_pts=51137
        declare -r test_pts=2098753
        train_pts[0]="1"
        train_pts[1]="33"
        train_pts[2]="545"
        train_pts[3]="6049"
        train_pts[4]="51137"
        train_pts[5]="353729"
        train_pts[6]="2098753"
    else
        echo "input dim is 2, 4, 8, 16, or 100"
    fi
else
    echo "training points must be either CC_sparse_grid or uniform_random"
fi

declare -A arch_layers
arch_layers[0]="1"
arch_layers[1]="2"
arch_layers[2]="3"
arch_layers[3]="4"
arch_layers[4]="5"
arch_layers[5]="10"
arch_layers[6]="20"
arch_layers[7]="30"

#declare -A arch_nodes
#arch_nodes[0]="20"
#arch_nodes[1]="40"
#arch_nodes[2]="60"
#arch_nodes[3]="80"
#arch_nodes[4]="100"
#arch_nodes[5]="200"
#arch_nodes[6]="400"
#arch_nodes[7]="600"

declare -A arch_nodes
arch_nodes[0]="10"
arch_nodes[1]="20"
arch_nodes[2]="30"
arch_nodes[3]="40"
arch_nodes[4]="50"
arch_nodes[5]="100"
arch_nodes[6]="200"
arch_nodes[7]="300"

for k in {5..5..1}
do
    # train and then test all of the point sets
    for i in {0..29..1} 
    do
        # train each trial for this point set
        echo "CONTROL: training ${train_pts[$i]} point trials"
        for j in {0..19..1}
        do
            echo "CONTROL: running trial $j of ${train_pts[$i]} point trials"
            #if (( ${train_pts[$i]} <= 10000 )); then
            #    echo "setting batch_size to train_pts"
            #    declare batch_size="${train_pts[$i]}"
            #elif (( ${train_pts[$i]} > 10000 && ${train_pts[$i]} <= 100000)); then
            #    echo "setting batch_size to train_pts = $((${train_pts[$i]}))"
            #    declare batch_size="$((${train_pts[$i]}))"
            #elif (( ${train_pts[$i]} > 100000 && ${train_pts[$i]} <= 1000000)); then
            #    echo "setting batch_size to train_pts/10 = $((${train_pts[$i]}/10))"
            #    declare batch_size="$((${train_pts[$i]}/10))"
            #elif (( ${train_pts[$i]} > 1000000 && ${train_pts[$i]} <= 10000000)); then
            #    echo "setting batch_size to train_pts/100 = $((${train_pts[$i]}/100))"
            #    declare batch_size="$((${train_pts[$i]}/100))"
            #fi
            #declare batch_size="$((${train_pts[$i]}/4))"
            declare batch_size="${train_pts[$i]}"

            # grow with the arch_nodes arch_layers sizes above
            python DNN.py --nb_layers ${arch_layers[$k]} --nb_nodes_per_layer ${arch_nodes[$k]} --nb_train_points ${train_pts[$i]} --train_pointset $training_ptset --nb_epochs $nb_epochs --batch_size $batch_size --nb_trials 20 --train 1 --make_plots $make_plots --nb_test_points $quick_test_pts --test_pointset CC_sparse_grid --blocktype $blocktype --activation $activation --example $example --optimizer $optimizer --quiet 0 --input_dim $input_dim --output_dim 1 --MATLAB_data 1 --trial_num $j --precision $precision --run_ID $run_ID --use_regularizer $use_regularizer --reg_lambda $reg_lambda --error_tol $error_tol --initializer $initializer --sigma $sigma --lrn_rate_schedule $lrn_rate_schedule
        done

        # test all of the trials for this point set
        echo "CONTROL: testing ${train_pts[$i]} point trials"

        # grow with the arch_nodes arch_layers sizes above
        python DNN.py --nb_layers ${arch_layers[$k]} --nb_nodes_per_layer ${arch_nodes[$k]} --nb_train_points ${train_pts[$i]} --train_pointset $training_ptset --nb_epochs $nb_epochs --nb_trials 20 --train 0 --make_plots 0 --nb_test_points $test_pts --test_pointset CC_sparse_grid --blocktype $blocktype --activation $activation --example $example --optimizer $optimizer --quiet 0 --input_dim $input_dim --output_dim 1 --MATLAB_data 1 --precision $precision --run_ID $run_ID --use_regularizer $use_regularizer --reg_lambda $reg_lambda --error_tol $error_tol --initializer $initializer --sigma $sigma --lrn_rate_schedule $lrn_rate_schedule

    done
done

